<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ActiveMQ</title>
    <link rel="icon" type="image/png" href="/activemq-website/assets/img/favicon.png">

    <link rel="stylesheet" href="/activemq-website/css/main.css">
    <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js" integrity="sha384-SlE991lGASHoBfWbelyBPLsUlwY1GwNDJo3jSJO04KZ33K2bwfV9YBauFfnzvynJ" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-light fixed-top">
    <div class="container">
        <!-- <a class="navbar-brand mr-auto" href="#"><img style="height: 50px" src="assets/img/apache-feather.png" /></a> -->
        <a class="navbar-brand mr-auto" href="#"><img src="/activemq-website/assets/img/activemq_logo_black_small.png" style="height: 50px"/></a>
        <button class="navbar-toggler ml-auto" type="button" data-toggle="collapse" data-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="ml-auto collapse navbar-collapse" id="navbarContent">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="/activemq-website/index.html">Home</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownProjects" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Projects</a>
                    <ul class="dropdown-menu dropdown-menu-center" aria-labelledby="navbarDropdownProjects">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <h6 class="dropdown-header">Projects</h6>
                                    <div class="dropdown-divider"></div>
                                    <li class="nav-item"><a class="dropdown-item" href="/activemq-website/projects/classic">ActiveMQ 5</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/activemq-website/projects/artemis/">ActiveMQ Artemis</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/activemq-website/projects/nms">NMS Clients</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/activemq-website/projects/cms">CMS Client</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownCommunity" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Contact</a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownCommunity">
                        <div class="row">
                            <div class="col-12">
                                <ul class="multi-column-dropdown">
                                    <h6 class="dropdown-header">Contact</h6>
                                    <div class="dropdown-divider"></div>
                                    <li class="nav-item"><a class="dropdown-item" href="/activemq-website/contact#mailing">Mailing Lists</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/activemq-website/contact#chat">Chat</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/activemq-website/contact#issues">Report Issues</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/activemq-website/contact#contributing">Contributing</a></li>
                                </ul>
                            </div>
                          </div>
                    </ul>
                </li>
                <!--li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownTeam" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Team</a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownTeam">
                        <div class="row">
                            <div class="col-sm-12">
                                <ul class="multi-column-dropdown">
                                    <h6 class="dropdown-header">Team</h6>
                                    <div class="dropdown-divider"></div>
                                    <li class="nav-item"><a class="dropdown-item" href="/activemq-website/team">PMC & Committers</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/activemq-website/team/reports">Board Reports</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li-->
                <li class="nav-item dropdown">
                    <a class="nav-link" id="navbarDropdownTeam" data-target="#" href="" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Apache</a>
                    <ul class="dropdown-menu dropdown-menu-center multi-column columns-1" aria-labelledby="navbarDropdownTeam">
                        <div class="row">
                            <div class="col-sm-12">
                                <ul class="multi-column-dropdown">
                                    <h6 class="dropdown-header">Apache</h6>
                                    <div class="dropdown-divider"></div>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org">The Apache Software Foundation</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/licenses/">License</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Sponsorship</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/security/">Security</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://www.apache.org/events/current-event">Events</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="https://people.apache.org/phonebook.html?pmc=activemq">PMC & Committers</a></li>
                                    <li class="nav-item"><a class="dropdown-item" href="/activemq-website/team/reports">Board Reports</a></li>
                                </ul>
                            </div>
                        </div>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="content">
  <div class="page-title-activemq5">
    <div class="container">
      <h1>Compile ActiveMQ with GCJ</h1>
    </div>
  </div>
  <div class="container" >
    <div class="row" style="margin-top: 30px">
      <div class="col-12 activemq5">
        <p><a href="connectivity">Connectivity</a> &gt; <a href="cross-language-clients">Cross Language Clients</a> &gt; <a href="c-integration">C Integration</a> &gt; <a href="compile-activemq-with-gcj">Compile ActiveMQ with GCJ</a></p>

<p>You can use <a href="http://gcc.gnu.org/java/">GCJ</a> to build ActiveMQ as a shared library you can reuse from C++.</p>

<h3 id="native-compile-activemq-howto">Native compile ActiveMQ HOWTO</h3>

<h4 id="abstract">Abstract</h4>

<p>This document describes how to native compile ActiveMQ for use in a C++ environment. The version of ActiveMQ used is 3.2 in this howto. To compile you’ll need GCC 4.0.2, or later, with both Java, and C/C++ support.</p>

<h4 id="tools-setup">Tools Setup</h4>

<p>If you don’t already have GCC 4.0.2 installed you need to download and build it. See GCC manuals for complete instructions on how to build GCC but below is a short descriptions of the steps involved. The GCC build steps assumes that you already have an older GCC compiler installed.</p>

<ul>
  <li>Unpack GCC into an arbitrary directory, for example /opt/gccbuild, and then create a separate output directory. Your directory structure should look similar to this;
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/opt/gccbuild/gcc-4.0.2
/opt/gccbuild/output
</code></pre></div>    </div>
  </li>
  <li>Go to the output directory and run configure.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd /opt/gccbuild/output
../gcc-4.0.2/configure --prefix=/opt/gcc402
                       --enable-shared
                       --enable-threads=posix
                       --enable-languages=c,c++,java
</code></pre></div>    </div>
  </li>
  <li>Run make.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make bootstrap
make install
</code></pre></div>    </div>
  </li>
  <li>Download ActiveMQ and copy the JARs to a new empty directory /opt/app, including
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>activeio-1.1.jar
activemq-core-3.2.jar
commons-logging-1.0.3.jar
concurrent-1.3.4.jar
geronimo-spec-j2ee-jacc-1.0-rc4.jar
geronimo-spec-j2ee-management-1.0-rc4.jar
geronimo-spec-jms-1.1-rc4.jar
geronimo-spec-jta-1.0.1B-rc4.jar
log4j-1.2.8.jar
</code></pre></div>    </div>
  </li>
</ul>

<h4 id="write-the-glue-code">Write the Glue Code</h4>

<p>Either access the ActiveMQ classes directly from C++ or write a facade object in Java that handles all startup and shutdown logic of ActiveMQ. Save the glue files in the same directory as for the ActiveMQ jars.</p>

<p>An CNI example using a Java object starting the MQ.</p>

<h5 id="bootstrapcpp">Bootstrap.cpp</h5>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;gcj/cni.h&gt;
#include &lt;iostream&gt;
#include &lt;java/lang/System.h&gt;
#include &lt;java/lang/Throwable.h&gt;
#include &lt;java/io/PrintStream.h&gt;
#include "MQAdapter.h"

using namespace std;

int main(int argc, char* argv\[\])
{
    cout &lt;&lt; "Entering main" &lt;&lt; endl;
    using namespace java::lang;

    try
    {
        // Create and startup Java VM
        JvCreateJavaVM(NULL) ;
        JvAttachCurrentThread(NULL, NULL) ;

        System::out-&gt;println(JvNewStringLatin1("Java println")) ;

        // Start ActiveMQ
        MQAdapter* pAdapter = new MQAdapter() ;
        pAdapter-&gt;start() ;

        // Send a message
        pAdapter-&gt;send(JvNewStringLatin1("Hello World!")) ;

        // Shutdown ActiveMQ
        pAdapter-&gt;stop() ;
     
        JvDetachCurrentThread() ;
    }
    catch( Throwable *t )
    {
        System::err-&gt;println(JvNewStringLatin1("Exception")) ;
        t-&gt;printStackTrace() ;
    }
}
</code></pre></div></div>

<h5 id="mqadapterjava">MQAdapter.java</h5>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import org.activemq.*;
import java.util.Hashtable ;
import javax.jms.*;
import javax.naming.*;

public class MQAdapter
{
    private InitialContext         jndiContext ;
    private QueueConnectionFactory factory ;
    private QueueConnection        connection ;
    private QueueSession           session ;
    private QueueSender            sender ;
    private Queue                  queue ;

    public MQAdapter()
    {
    }

    public void start()
    {
        try
        {
            Hashtable props = new Hashtable() ;
            props.put(Context.INITIAL\_CONTEXT\_FACTORY, "org.activemq.jndi.ActiveMQInitialContextFactory") ;
            props.put(Context.PROVIDER_URL, "tcp://localhost:61616") ;
            props.put("queue.MyQueue", "example.MyQueue") ;

            jndiContext = new InitialContext(props) ;
        
            // Create and configure JMS connection factory
            factory = (QueueConnectionFactory)jndiContext.lookup("ConnectionFactory") ;

            // Lookup Queue
            queue = (Queue)jndiContext.lookup("MyQueue") ;

            // Create a JMS connection
            connection = (QueueConnection)factory.createQueueConnection() ;
            System.out.println("Created connection: " + connection) ;

            // Create a JMS session
            session = connection.createQueueSession(false, Session.AUTO_ACKNOWLEDGE) ;
            System.out.println("Created session: " + session) ;

            // Create JMS sender
            sender  = session.createSender(queue) ;
        }
        catch( Exception e )
        {
            e.printStackTrace() ;

            try
            {
                if( connection != null )
                    connection.close() ;
            } catch( JMSException jmse )
            { /* ignore */ }
        }
    }

    public void stop()
    {
        try
        {
            if( connection != null )
                connection.close() ;
        } catch( JMSException e )
        { /* ignore */ }
    }

    public void send(String msg)
    {
        TextMessage message ;

        try
        {
            message = session.createTextMessage(msg) ;
            sender.send(message) ;
        }
        catch( JMSException e )
        {
            e.printStackTrace() ;
        }
    }
}
</code></pre></div></div>

<h4 id="compile-the-java-and-c-code">Compile the Java and C++ Code</h4>

<p>The Java code must be BC compiled to be able to dynamically link required classes as needed, see reference for more information on BC compilation. Use the suggested script to compile all ActiveMQ JARs and create a class map database.</p>

<blockquote>
  <p><strong>Note</strong></p>

  <p>Using -Bsymbolic does not seem to work, use -symbolic instead.</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>compile.sh:

#!/bin/sh

# Create new classmap database
gcj-dbtool -n classmap.db

for JAR_FILE in \`find -iname "*.jar"\`
do
    echo "Compiling ${JAR_FILE} to native"
    gcj -shared -findirect-dispatch -fjni -fPIC -Wl,-symbolic -o ${JAR\_FILE}.so ${JAR\_FILE}
    gcj-dbtool -a classmap.db ${JAR\_FILE} ${JAR\_FILE}.so
done
</code></pre></div></div>

<ul>
  <li>Run the above script and set environment property GCJ_PROPERTIES.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./compile.sh
export GCJ_PROPERTIES="gnu.gcj.precompiled.db.path=/opt/app/classmap.db"
</code></pre></div>    </div>
  </li>
  <li>Java compile MQAdapter.java
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcj --classpath=./geronimo-spec-jms-1.1-rc4.jar:./activemq-core-3.2.jar -C MQAdapter.java
</code></pre></div>    </div>
  </li>
  <li>Generate CNI header for MQAdapter.class
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcjh MQAdapter
</code></pre></div>    </div>
  </li>
  <li>JAR the Java glue code
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fastjar cf MQAdapter.jar MQAdapter.class
</code></pre></div>    </div>
  </li>
  <li>Native compile the Java JAR into a shared library, add output directory to LD_LIBRARY_PATH.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcj -shared -findirect-dispatch -fjni -fPIC -Wl,-symbolic -o MQAdapter.so MQAdapter.jar
export LD\_LIBRARY\_PATH=$LD\_LIBRARY\_PATH:/opt/app
</code></pre></div>    </div>
  </li>
  <li>Compile the C++ code
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>g++ -c Bootstrap.cpp
</code></pre></div>    </div>
  </li>
  <li>Link Bootstrap with the Java code
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcj -o Bootstrap Bootstrap.o -L /opt/app -lgcj -lstdc++ activeio-1.1.jar.so activemq-core-3.2.jar.so
    commons-logging-1.0.3.jar.so concurrent-1.3.4.jar.so geronimo-spec-jms-1.1-rc4.jar.so
    geronimo-spec-j2ee-management-1.0-rc4.jar.so geronimo-spec-j2ee-jacc-1.0-rc4.jar.so
    geronimo-spec-jta-1.0.1B-rc4.jar.so log4j-1.2.8.jar.so MQAdapter.so
</code></pre></div>    </div>
  </li>
</ul>

<p>Now, if everything went ok you should be able to run the app. with <code class="highlighter-rouge">./Bootstrap</code>.</p>

<h4 id="references">References</h4>

<p><a href="http://gcc.gnu.org/wiki/How%20to%20BC%20compile%20with%20GCJ">How to BC compile with GCJ</a></p>

<p><a href="http://www.redhat.com/magazine/012oct05/features/java/">The state of Java on Linux</a></p>


      </div>
    </div>
  </div>
</div>
<div class="row sitemap">
  <div class="col-sm-12">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <div class="row">
            <div class="col-sm-3">
              <div >
                <img class="float-left" style="max-height: 100px" src="/activemq-website/assets/img/activemq_logo_white_vertical_small.png"/>
              </div>
            </div>
            <div style="text-align: center; margin-bottom: 0px; margin-top: 30px; font-size: 65%" class="col-sm-6">
              <p>Apache ActiveMQ, ActiveMQ, ActiveMQ Artemis, Apache, the Apache feather logo, and the Apache ActiveMQ project logo are trademarks of The Apache Software Foundation. Copyright &copy; 2019, The Apache Software Foundation. Licensed under <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License 2.0</a>.</p>
            </div>
            <div class="col-sm-3">
              <div >
                <a href="https://www.apache.org"><img class="float-right" style="margin-top: 10px; max-height: 80px" src="/activemq-website/assets/img/apache-logo-small.png"/></a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
